---
.reusable_build_flags: &reusable_build_flags
  ? "--incompatible_config_setting_private_default_visibility"
  ? "--incompatible_disallow_empty_glob"

.reusable_test_flags: &reusable_test_flags
  <<: *reusable_build_flags
  ? "--test_env=PATH"

.reusable_targets: &reusable_targets
  ? "--"
  ? "//..."
  ? "@bazel_skylib_gazelle_plugin//..."

.reusable_config: &reusable_config
  build_flags: *reusable_build_flags
  test_flags: *reusable_test_flags
  build_targets: *reusable_targets
  test_targets: *reusable_targets

tasks:
  ubuntu2004_bazel5:
    <<: *reusable_config
    name: "Bazel 5.x"
    platform: ubuntu2004
    bazel: 5.x

  ubuntu2004_bazel6:
    <<: *reusable_config
    name: "Bazel 6.x"
    platform: ubuntu2004
    bazel: 6.x
    build_targets:
    <<: *reusable_targets
    # rules_pkg fails with --noenable_bzlmod
    ? "-//distribution/..."
    test_targets:
    <<: *reusable_targets
    # rules_pkg fails with --noenable_bzlmod
    ? "-//distribution/..."

  ubuntu2004_bazel6_enable_bzlmod:
    <<: *reusable_config
    name: "Bazel 6.x with --enable_bzlmod"
    platform: ubuntu2004
    bazel: 6.x
    build_flags:
    <<: *reusable_build_flags
    ? "--enable_bzlmod"
    test_flags:
    <<: *reusable_test_flags
    ? "--enable_bzlmod"

  ubuntu2004_latest:
    <<: *reusable_config
    name: "Latest Bazel"
    platform: ubuntu2004
    bazel: latest

  ubuntu2004_latest_noenable_bzlmod:
    <<: *reusable_config
    name: "Latest Bazel with --noenable_bzlmod"
    platform: ubuntu2004
    bazel: latest
    build_flags:
    <<: *reusable_build_flags
    ? "--noenable_bzlmod"
    test_flags:
    <<: *reusable_test_flags
    ? "--noenable_bzlmod"
    build_targets:
    <<: *reusable_targets
    # rules_pkg fails with --noenable_bzlmod
    ? "-//distribution/..."
    test_targets:
    <<: *reusable_targets
    # rules_pkg fails with --noenable_bzlmod
    ? "-//distribution/..."

  ubuntu1804_latest:
    <<: *reusable_config
    name: "Latest Bazel"
    platform: ubuntu1804
    bazel: latest

  ubuntu1604_latest:
    <<: *reusable_config
    name: "Latest Bazel"
    platform: ubuntu1604
    bazel: latest
    build_targets:
    <<: *reusable_targets
    # //distribution requires Python >= 3.6 for some rules_pkg scripts; Ubuntu 16.04 has Python 3.5
    ? "-//distribution/..."
    test_targets:
    <<: *reusable_targets
    # //distribution requires Python >= 3.6 for some rules_pkg scripts; Ubuntu 16.04 has Python 3.5
    ? "-//distribution/..."

  macos_latest:
    <<: *reusable_config
    name: "Latest Bazel"
    platform: macos
    bazel: latest

  windows_latest:
    <<: *reusable_config
    name: "Latest Bazel"
    platform: windows
    bazel: latest
    test_flags:
    <<: *reusable_test_flags
    # TODO(laszlocsomor): remove "--test_env=LOCALAPPDATA" after
    # https://github.com/bazelbuild/bazel/issues/7761 is fixed
    ? "--test_env=LOCALAPPDATA"
    ? "--test_tag_filters=-no_windows"

  ubuntu2004_last_green:
    <<: *reusable_config
    name: "Last Green Bazel"
    platform: ubuntu1804
    bazel: last_green

  macos_last_green:
    <<: *reusable_config
    name: "Last Green Bazel"
    platform: macos
    bazel: last_green

  windows_last_green:
    <<: *reusable_config
    name: "Last Green Bazel"
    platform: windows
    bazel: last_green
    test_flags:
    <<: *reusable_test_flags
    # TODO(laszlocsomor): remove "--test_env=LOCALAPPDATA" after
    # https://github.com/bazelbuild/bazel/issues/7761 is fixed
    ? "--test_env=LOCALAPPDATA"
    ? "--test_tag_filters=-no_windows"

buildifier: latest
